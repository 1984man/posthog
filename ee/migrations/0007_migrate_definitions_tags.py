# Generated by Django 3.2.5 on 2022-01-28 19:21
from django.db import migrations


def forwards(apps, schema_editor):
    EnterpriseTaggedItem = apps.get_model("posthog", "EnterpriseTaggedItem")

    # Create new event definition tags
    EnterpriseEventDefinition = apps.get_model("ee", "EnterpriseEventDefinition")
    for instance in EnterpriseEventDefinition.objects.raw(
        "SELECT * FROM ee_enterpriseeventdefinition WHERE tags!='{}' AND tags IS NOT NULL"
    ):
        for tag in instance.tags:
            new_tag = EnterpriseTaggedItem(content_object=instance, tag=tag, team_id=instance.team_id)
            new_tag.save()

    # Create new property definition tags
    EnterprisePropertyDefinition = apps.get_model("ee", "EnterprisePropertyDefinition")
    for instance in EnterprisePropertyDefinition.objects.raw(
        "SELECT * FROM ee_enterprisepropertydefinition WHERE tags!='{}' AND tags IS NOT NULL"
    ):
        for tag in instance.tags:
            new_tag = EnterpriseTaggedItem(content_object=instance, tag=tag, team_id=instance.team_id)
            new_tag.save()


def reverse(apps, schema_editor):
    EnterpriseEventDefinition = apps.get_model("ee", "EnterpriseEventDefinition")
    for instance in EnterpriseEventDefinition.objects.raw(
        "SELECT * FROM ee_enterpriseeventdefinition WHERE tags!='{}' AND tags IS NOT NULL"
    ):
        instance.global_tags.clear()

    EnterprisePropertyDefinition = apps.get_model("ee", "EnterprisePropertyDefinition")
    for instance in EnterprisePropertyDefinition.objects.raw(
        "SELECT * FROM ee_enterprisepropertydefinition WHERE tags!='{}' AND tags IS NOT NULL"
    ):
        instance.global_tags.clear()


class Migration(migrations.Migration):

    dependencies = [("ee", "0006_event_definition_verification"), ("posthog", "0201_global_tags_setup")]

    operations = [
        migrations.RunPython(forwards, reverse),
    ]
