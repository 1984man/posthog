# Generated by Django 3.2.5 on 2022-01-28 19:21
from django.db import migrations
from django.db.models import Q

from posthog.models.tagged_item import EnterpriseTaggedItem


def forwards(apps, schema_editor):
    # Create new event definition tags
    EnterpriseEventDefinition = apps.get_model("ee", "EnterpriseEventDefinition")
    for instance in EnterpriseEventDefinition.objects.exclude(deprecated_tags__isnull=True, deprecated_tags=[]):
        if instance.deprecated_tags:
            for tag in instance.deprecated_tags:
                new_tag = EnterpriseTaggedItem(
                    event_definition_id=instance.eventdefinition_ptr_id, tag=tag, team_id=instance.team_id
                )
                new_tag.save()

    # Create new property definition tags
    EnterprisePropertyDefinition = apps.get_model("ee", "EnterprisePropertyDefinition")
    for instance in EnterprisePropertyDefinition.objects.exclude(deprecated_tags__isnull=True, deprecated_tags=[]):
        if instance.deprecated_tags:
            for tag in instance.deprecated_tags:
                new_tag = EnterpriseTaggedItem(
                    property_definition_id=instance.propertydefinition_ptr_id, tag=tag, team_id=instance.team_id
                )
                new_tag.save()


def reverse(apps, schema_editor):
    EnterpriseTaggedItem = apps.get_model("posthog", "EnterpriseTaggedItem")
    EnterpriseTaggedItem.objects.filter(
        Q(event_definition_id__isnull=False) | Q(property_definition_id__isnull=False)
    ).delete()


class Migration(migrations.Migration):

    dependencies = [("ee", "0007_global_tags_setup"), ("posthog", "0203_global_tags_setup")]

    operations = [
        migrations.RunPython(forwards, reverse),
    ]
