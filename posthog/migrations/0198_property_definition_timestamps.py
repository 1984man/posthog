# Generated by Django 3.2.5 on 2022-01-19 23:51

import json

import django.utils.timezone
from django.conf import settings
from django.db import migrations, models

from posthog.constants import AnalyticsDBMS


def set_created_at(apps, schema_editor):
    try:
        from ee.clickhouse.client import sync_execute
    except ImportError:
        sync_execute = None  # type: ignore

    EventDefinition = apps.get_model("posthog", "EventDefinition")
    PropertyDefinition = apps.get_model("posthog", "PropertyDefinition")
    for instance in EventDefinition.objects.filter(created_at=None):
        created_at = None
        property_keys = []
        if settings.PRIMARY_DB == AnalyticsDBMS.POSTGRES:
            Event = apps.get_model("posthog", "Event")
            # Get first instance of event
            event_instance = (
                Event.objects.only("timestamp", "properties")
                .filter(team=instance.team, event=instance.name)
                .order_by("timestamp")
                .first()
            )
            if event_instance:
                created_at = event_instance.timestamp
                property_keys = list(event_instance.properties.keys())
        else:
            if sync_execute:
                result = sync_execute(
                    "SELECT timestamp, properties FROM events where team_id=%(team_id)s AND event=%(event)s"
                    " order by timestamp limit 1",
                    {"team_id": instance.team.pk, "event": instance.name,},
                )

            if result:
                created_at = result[0][0]
                property_keys = list(json.loads(result[0][1]).keys())

        if created_at and property_keys:
            # Update all property definitions at once.
            properties = PropertyDefinition.objects.filter(team=instance.team, name__in=property_keys)
            properties.update(created_at=created_at)


def undo_set_created_at(apps, schema_editor):
    PropertyDefinition = apps.get_model("posthog", "PropertyDefinition")
    properties = PropertyDefinition.objects.all()
    properties.update(created_at=None)


class Migration(migrations.Migration):

    dependencies = [
        ("posthog", "0197_plugin_is_stateless"),
    ]

    operations = [
        migrations.AddField(
            model_name="propertydefinition",
            name="created_at",
            field=models.DateTimeField(default=django.utils.timezone.now, null=True),
        ),
        migrations.AddField(
            model_name="propertydefinition", name="last_seen_at", field=models.DateTimeField(default=None, null=True),
        ),
        migrations.RunPython(set_created_at, undo_set_created_at),
    ]
