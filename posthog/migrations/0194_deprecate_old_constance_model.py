# Generated by Django 3.2.5 on 2021-12-22 09:58

import json
import logging
import pickle
from base64 import b64decode

from django.db import connection, migrations, utils

logger = logging.getLogger(__name__)


def populate_constance(apps, schema_editor):
    try:
        Constance = apps.get_model("posthog", "Constance")
        with connection.cursor() as cursor:
            cursor.execute("SELECT key, value FROM constance_config")
            for key, pickled_value in cursor.fetchall():
                value = pickle.loads(b64decode(pickled_value.encode()))
                Constance.objects.create(key=key, raw_value=json.dumps(value))
    except utils.ProgrammingError:
        logger.info("constance_config table did not exist, skipping populating posthog_constance table")


def rollback(apps, schema_editor):
    pass


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("posthog", "0193_new_constance_model"),
    ]

    operations = [
        migrations.RunPython(populate_constance, rollback),
    ]
